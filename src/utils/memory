import psutil
import gc
import time
import hashlib
import numpy as np

class MemoryManager:
    """Active memory monitoring and garbage collection."""
    
    def __init__(self, limit_mb=2048):
        self.limit = limit_mb * 1024 * 1024
        self.process = psutil.Process()
        
    def check_memory(self):
        if self.process.memory_info().rss > self.limit:
            print("⚠️ Memory limit reached. Forcing GC...")
            gc.collect()

class SmartCache:
    """Hash-based LRU Cache for image features."""
    
    def __init__(self, max_size=5):
        self.cache = {}
        self.max_size = max_size
        
    def generate_key(self, array):
        # Fast sampling hash for large arrays
        if array.size > 10000:
            idx = np.linspace(0, array.size-1, 100).astype(int)
            sample = array.ravel()[idx].tobytes()
        else:
            sample = array.tobytes()
        return hashlib.md5(sample).hexdigest()
        
    def get(self, key):
        return self.cache.get(key)
        
    def put(self, key, value):
        if len(self.cache) >= self.max_size:
            self.cache.pop(next(iter(self.cache)))
        self.cache[key] = value
